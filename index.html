<!DOCTYPE html>
<html lang="ar">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">


  <script>
    function enterFullscreen() {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      } else if (document.documentElement.mozRequestFullScreen) { // Firefox
        document.documentElement.mozRequestFullScreen();
      } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari
        document.documentElement.webkitRequestFullscreen();
      } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
        document.documentElement.msRequestFullscreen();
      }
    }
  
    window.addEventListener('load', function () {
      enterFullscreen(); // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸàÿ∏ŸäŸÅÿ© ÿ™ŸèŸÜŸÅÿ∞ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    });
  </script>
  
  
  <script src="https://unpkg.com/hammerjs@2.0.8/hammer.min.js"></script>

  <title>Block Puzzle AI</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>

    
body {
  padding: 0;
  margin: 0;
}


body {
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}


    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #eef6fb;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      touch-action: manipulation;
      overflow: hidden;
      padding: 10px;
    }
    
    .back-home-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #2196F3;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .back-home-btn:hover {
      background: #2196F3;
      transform: scale(1.1);
    }
    
    .back-home-btn svg {
      stroke: #2196F3;
      transition: all 0.3s ease;
    }
    
    .back-home-btn:hover svg {
      stroke: white;
    }
    
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background: #eef6fb;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .active { display: flex; }
    
    h1, h2 {
      color: #2196f3;
      margin: 10px;
      font-weight: 600;
    }
    
    .btn {
      background: linear-gradient(45deg, #2196f3, #21cbf3);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.2em;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    
    #scoreboard {
      font-size: 1.2rem;
      margin: 10px;
      font-weight: bold;
      color: #2196F3;
    }
    
    #grid {
      display: grid;
      gap: 2px;
      margin: 10px auto;
      width: 90vmin;
      height: 90vmin;
      max-width: 400px;
      max-height: 400px;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
    }
    
    .cell {
      width: 100%;
      height: 100%;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    
    .filled { background: #2196f3; }
    .preview { background-color: rgba(33, 150, 243, 0.5); }
    .line-clear-preview { background-color: rgba(76, 175, 80, 0.6) !important; }
    
    #shapes {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px auto;
      width: 100%;
      max-width: 600px;
    }
    
    .shape {
      display: grid;
      grid-template-columns: repeat(4, clamp(20px, 5vmin, 60px));
      grid-template-rows: repeat(4, clamp(20px, 5vmin, 60px));
      gap: 2px;
      cursor: grab;
      touch-action: none;
      padding: 10px;
    }
    
    .block {
      width: 100%;
      height: 100%;
      background: #2196f3;
      border-radius: 4px;
      transition: transform 0.15s ease;
      pointer-events: none;
    }
    
    .floating {
      position: absolute;
      z-index: 999;
      pointer-events: none;
      opacity: 0.95;
      transition: left 0.07s ease, top 0.07s ease;
      transform: none !important;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 2px;
    }
    
    #finalScoreDisplay {
      font-size: 2.5rem;
      color: #4caf50;
      font-weight: bold;
      margin-top: 20px;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.6s ease;
    }
    
    #finalScoreDisplay.show {
      opacity: 1;
      transform: scale(1.1);
    }
    
    #countdown {
      font-size: 1.1rem;
      margin-top: 10px;
      color: #888;
    }
    
    /* üëá AI Reaction Container */
    #aiContainer {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 120px;
    }
    
    #aiInteractiveArea {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-bottom: 10px;
      position: relative;
      min-height: 100px;
    }
    
    .ai-bubble {
      position: relative;
      width: 80px;
      height: 80px;
      opacity: 0;
      transform: scale(0.5) translateY(20px);
      transition: all 0.4s ease;
      z-index: 10;
      margin-right: 15px;
    }
    
    .ai-bubble.show {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    
    .bubble-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff22, #00000033);
      border: 2px solid #ffffff55;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: float 4s ease-in-out infinite;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.1);
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    
    .bubble-inner img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      animation: avatarPulse 2.8s ease-in-out infinite, avatarBlink 6s ease-in-out infinite;
      transform-origin: center center;
    }
    
    @keyframes avatarPulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.2); filter: brightness(1.25); }
    }
    
    @keyframes avatarBlink {
      0%, 96%, 100% { transform: scaleY(1); filter: brightness(1); }
      97% { transform: scaleY(0.1); filter: brightness(0.3); }
      98% { transform: scaleY(1); filter: brightness(1); }
    }
    
    #aiBoard {
  width: 90vmin;
  max-width: 400px;
  min-height: 80px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 10px 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  opacity: 0;
  transform: scaleX(0);
  transition: all 0.4s ease;
  overflow: hidden;
}
    
    #aiBoard.show {
      transform: scaleX(1);
      opacity: 1;
    }
    
    #aiText {
  font-size: 1.2rem;
  font-weight: 600;
  color: #2196f3;
  text-align: center;
  line-height: 1.4;
  padding: 0 10px;
  word-break: break-word;
  max-width: 100%;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.5s ease;
  margin: 0;
}

    
    #aiText.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    #aiHeatBar {
      width: 100%;
      height: 8px;
      background: linear-gradient(to right, #ff5722, #ffc107);
      border-radius: 6px;
      margin-top: 10px;
      transform: scaleX(0);
      transform-origin: left;
      opacity: 0;
      transition: transform 3s linear, opacity 0.5s ease;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    
    #aiHeatBar.active {
      transform: scaleX(1);
      opacity: 1;
    }
    
    @keyframes bubbleEnter {
      0% { opacity: 0; transform: scale(0.2) rotate(0deg); filter: blur(4px); }
      20% { opacity: 1; transform: scale(1.05) rotate(2deg); }
      40% { transform: scale(0.95) rotate(-2deg); }
      60% { transform: scale(1.02) rotate(1deg); }
      80% { transform: scale(0.98) rotate(-1deg); }
      100% { transform: scale(1) rotate(0deg); filter: blur(0); }
    }
    
    @keyframes bubbleExit {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.5) rotate(-10deg); filter: blur(3px); }
    }
    
    .ai-bubble.show {
      animation: bubbleEnter 0.4s ease-out forwards;
    }
    
    .ai-bubble.hide {
      animation: bubbleExit 0.4s ease-in forwards;
    }
    
    @keyframes boardEnter {
      0% { transform: translateX(-100%) scaleX(0); opacity: 0; }
      60% { transform: translateX(20%) scaleX(1.1); opacity: 1; }
      100% { transform: translateX(0) scaleX(1); opacity: 1; }
    }
    
    @keyframes boardExit {
      0% { transform: translateX(0) scaleX(1); opacity: 1; }
      100% { transform: translateX(-100%) scaleX(0); opacity: 0; }
    }
    
    #aiBoard.show {
      animation: boardEnter 0.5s ease-out forwards;
    }
    
    #aiBoard.hide {
      animation: boardExit 0.5s ease-in forwards;
    }
    
    .welcome-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #eef6fb;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
    }
    
    .welcome-card {
  background: linear-gradient(to bottom, #ffffff, #f3faff);
  padding: 30px 25px;
  border-radius: 24px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  text-align: center;
  max-width: 380px;
  width: 90%;
  animation: fadeInCard 0.5s ease-out;
}

@keyframes fadeInCard {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}


    .welcome-card p {
      font-size: 1.3rem;
      margin-bottom: 15px;
    }
    
    .welcome-card .btn {
      margin: 8px;
    }
    
    .game-title {
      font-size: 3.5rem;
      color: #2196F3;
      margin: 0 0 30px 0;
      font-weight: 800;
      text-shadow: 0 3px 6px rgba(0,0,0,0.1);
      animation: pulse 2s infinite;
      display: inline-block;
      padding: 0 20px;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    #menu {
      overflow: hidden;
      padding: 0 15px;
      justify-content: center;
    }
    
    .menu-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      margin-top: -50px;
    }
    
    .start-btn {
      padding: 15px 40px;
      font-size: 1.5rem;
      margin: 10px 0;
    }
    
    .stats-btn {
      background: rgba(33, 150, 243, 0.1);
      color: #2196F3;
      margin: 10px 0 30px 0;
    }
    
    .copyright {
      font-size: 0.8rem; 
      color: #777;
      margin-top: 40px;
      position: absolute;
      bottom: 20px;
    }
    
    .hidden {
      display: none !important;
    }
    
    #aiFlash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      transition: opacity 0.2s ease;
    }
    
/* ÿßŸÑŸÜŸÇÿßÿ∑ */
.ai-dots {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 3px;
  margin-top: 6px;
  animation: curveDots 2s infinite ease-in-out;
}

@keyframes curveDots {
  0% { transform: translateX(-50%) translateY(0) rotate(0deg); }
  50% { transform: translateX(-50%) translateY(3px) rotate(25deg); }
  100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
}

.ai-dots span {
  width: 6px;
  height: 6px;
  background: white;
  border-radius: 50%;
  opacity: 0.6;
  animation: dotFlash 1s infinite alternate;
}

.ai-dots span:nth-child(2) { animation-delay: 0.2s; }
.ai-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes dotFlash {
  0% { transform: scale(1); opacity: 0.4; }
  100% { transform: scale(1.3); opacity: 1; }
}

/* Avatar blinking effect */
#aiAvatar.blink {
  opacity: 0.3;
  transition: opacity 0.2s;
}

@keyframes mockShake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
}

#aiBubble.mocking {
  animation: mockShake 0.6s ease;
}

@keyframes shakeButton {
  0% { transform: translate(0, 0); }
  20% { transform: translate(-3px, 0); }
  40% { transform: translate(3px, 0); }
  60% { transform: translate(-3px, 0); }
  80% { transform: translate(3px, 0); }
  100% { transform: translate(0, 0); }
}

.shaky {
  animation: shakeButton 0.6s infinite;
}

@keyframes pulseGlow {
  0% { box-shadow: 0 0 10px #21cbf3, 0 0 20px #21cbf3; transform: scale(1); }
  50% { box-shadow: 0 0 20px #00ff99, 0 0 30px #00ff99; transform: scale(1.05); }
  100% { box-shadow: 0 0 10px #21cbf3, 0 0 20px #21cbf3; transform: scale(1); }
}

@keyframes colorShift {
  0% { background: linear-gradient(45deg, #2196f3, #21cbf3); }
  50% { background: linear-gradient(45deg, #00e676, #00c853); }
  100% { background: linear-gradient(45deg, #2196f3, #21cbf3); }
}

.power-btn {
  animation: pulseGlow 2s infinite, colorShift 5s infinite;
}

@keyframes countdownColor {
  0% { color: #00c853; }
  50% { color: #ffc107; }
  100% { color: #f44336; }
}

.countdown-animate {
  animation: countdownColor 5s linear forwards;
}

@keyframes scoreBounce {
  0% { transform: scale(0.5); opacity: 0; }
  60% { transform: scale(1.2); opacity: 1; }
  80% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

.bounce-in {
  animation: scoreBounce 1s ease forwards;
}

.golden-btn {
  background: linear-gradient(45deg, #ffd700, #ffb300);
  color: #fff8dc;
  border: none;
  padding: 15px 30px;
  font-size: 1.4rem;
  font-weight: bold;
  border-radius: 16px;
  cursor: pointer;
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
  animation: goldenPulse 2s infinite alternate;
  transition: all 0.3s ease;
}

.golden-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
}

@keyframes goldenPulse {
  0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); }
  100% { box-shadow: 0 0 20px rgba(255, 215, 0, 1); }
}

.welcome-btn {
  padding: 14px 28px;
  font-size: 1.2rem;
  font-weight: 600;
  border: none;
  border-radius: 20px;
  background: linear-gradient(135deg, #2196f3, #21cbf3);
  color: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 140px;
}

.welcome-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}

.sound-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  background: rgba(255, 255, 255, 0.9);
  border: 2px solid #2196F3;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.sound-btn:hover {
  background: #2196F3;
  transform: scale(1.1);
}

.sound-btn:hover svg {
  stroke: white;
  fill: white;
}

.sound-btn svg {
  transition: all 0.3s ease;
}

    </style>
    <!-- ÿ∂ÿπ Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿ≥ÿ∑ÿ± ŸÇÿ®ŸÑ </head> -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  * {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  body {
    margin: 0;
    overflow: hidden;
  }
</style>

<!-- ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿ≥ÿ∑ÿ± -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<script>
  // ÿ≠ŸÑ ÿ≥ÿ≠ÿ±Ÿä ŸÑŸÖŸÜÿπ ÿßŸÑÿ™ÿ®ÿßÿ∑ÿ§
  document.addEventListener('DOMContentLoaded', () => {
    SoundManager.loadSounds();
    
  const originalPlay = SoundManager.play;
SoundManager.play = function(name) {
  if (!isSoundOn) return;
  originalPlay.call(SoundManager, name);
};
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => {}, { timeout: 1000 });
    }
  });


  // ÿ≠ŸÑ ŸÜŸáÿßÿ¶Ÿä ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿØÿßÿ°
if ('connection' in navigator) {
  if (navigator.connection.saveData || navigator.connection.effectiveType.includes('2g')) {
    document.body.classList.add('low-performance');
  }
}


/*** ÿßÿ®ÿØÿ£ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ***/
// ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± (ÿ•ÿ∞ÿß Ÿàÿ¨ÿØÿ™)
const images = document.querySelectorAll('img');
if (images.length > 0) {
  images.forEach(img => {
    img.loading = 'eager';
    img.decoding = 'async';
  });
}
/*** ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ∂ÿßŸÅ ***/

// ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿπŸÜÿßÿµÿ±

const Pan = new Hammer.Pan({ threshold: 5 });




  



 
  





</script>




<script>
  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ≠ÿ±ÿ¨ÿ© ÿ£ŸàŸÑÿßŸã (ŸäŸÇŸÑŸÑ ÿßŸÑÿ™ŸàŸÇŸÅ)
  document.addEventListener('DOMContentLoaded', () => {
   

    const criticalAssets = [
      'assets/ai_default.png',
      'assets/sounds/button-click.mp3'
    ];
    
    criticalAssets.forEach(asset => {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = asset.includes('.mp3') ? 'audio' : 'image';
      link.href = asset;
      document.head.appendChild(link);
    });
  });
  </script>



</head>
<body>
  <div class="welcome-screen" id="welcomeScreen">
    <div class="welcome-card">
      <p id="welcomeText" style="display:none;"></p>


      <div id="langButtons" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 10px;">
        <button onclick="chooseLanguage('ar')" class="welcome-btn">üåç ÿπÿ±ÿ®Ÿä</button>
        <button onclick="chooseLanguage('en')" class="welcome-btn">üåç English</button>
      </div>
      
     
<div id="step2" style="display:none; margin-top: 20px;">
  <p id="genderText">üë§ ÿ•ŸÜÿ™ ŸàŸÑÿØ ŸàŸÑÿß ÿ®ŸÜÿ™ÿü</p>
  <div style="display: flex; gap: 20px; justify-content: center; margin-top: 10px;">
    <button onclick="chooseGender('male')" class="welcome-btn">üöπ ŸàŸÑÿØ</button>
    <button onclick="chooseGender('female')" class="welcome-btn">üö∫ ÿ®ŸÜÿ™</button>
  </div>
</div>

      

      
      <div id="finalStep" style="display:none;"></div>

      
    </div>
  </div>
</div> <!-- ŸÜŸáÿßŸäÿ© welcomeScreen -->

<!-- ŸáŸÜÿß ÿ™ÿ≠ÿ∑ ÿ¥ÿßÿ¥ÿ© avatarIntroScreen ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
<div class="welcome-screen hidden" id="avatarIntroScreen">
  <div id="avatarWrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;">
    
    <div id="introAiBubble" class="ai-bubble show" style="width:120px;height:120px;">
      <div class="bubble-inner" style="width:100%;height:100%;">
        <img id="introAiAvatar" src="assets/ai_default.png" alt="AI" style="width:90px;height:90px;"/>
        <div class="ai-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
    
    <div id="introAiBoard" class="show" style="
  background: white;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  width: 90%;
  max-width: 400px;
  height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;">

      <div id="introAiText" style="font-size:1.3rem;color:#2196F3;line-height:1.5;text-align:center;word-wrap:break-word;"></div>
    </div>

  </div>
</div>



  <!-- Screens -->
  <div class="screen active" id="menu">
    <div class="menu-content">
      <h1 class="game-title">Block Puzzle AI</h1>
      <button class="btn start-btn" onclick="startGame()">ÿßÿ®ÿØÿ£ ÿ±ÿ≠ŸÑÿ™Ÿä</button>
      <button class="btn stats-btn" onclick="showPlayerStats()">üìà ÿ®ŸäÿßŸÜÿßÿ™Ÿä</button>
     <button id="soundToggleBtn" class="sound-btn" onclick="toggleSound()">
  <svg viewBox="0 0 24 24" width="24" height="24">
    <path id="soundIcon" fill="#2196F3"
      d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
  </svg>
</button>

      <p class="copyright">By: NovaCode Studio ¬© 2025</p>
  
      <div id="adBanner" style="width:100%; height:50px; background:#e6e6e6; display:flex; align-items:center; justify-content:center; font-size:14px; color:#333; margin-top: 20px;">
        ÿ•ÿπŸÑÿßŸÜ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸáŸÜÿß (Banner)
      </div>
    </div>
  </div>
  
  <div class="screen" id="game">
    <button id="backToMenuBtn" onclick="backToMenu()" class="back-home-btn">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path d="M19 12H5M12 19l-7-7 7-7" stroke="#2196F3" stroke-width="2"/>
      </svg>
    </button>
    
    <div id="scoreboard">Score: 0</div>
    
    <!-- AI Interactive Area -->
    <div id="aiContainer">
      <div id="aiInteractiveArea">
        <div id="aiBubble" class="ai-bubble hidden">
          <div class="bubble-inner">
            <img id="aiAvatar" src="assets/ai_default.png" alt="AI" />
            <div class="ai-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
        
        <div id="aiBoard" class="hidden">
          <div id="aiText"></div>
          <div id="aiHeatBar"></div>
        </div>
      </div>
    </div>
    
    <div id="grid"></div>
    <div id="shapes"></div>
  </div>

  <div class="screen" id="gameover">
    <h1>Game Over</h1>
    <div id="finalScoreDisplay"></div>
    <p id="motivationalText" style="font-size: 1.2rem; margin: 10px 0; color: #f4a300; font-weight: bold;"></p>
    <button class="golden-btn" id="resumeBtn" onclick="resumeGame()">‚ú® ÿßÿ≥ÿ™ŸÉŸÖŸÑ ÿßŸÑŸÑÿπÿ®</button>
    <button class="btn" id="restartBtn" style="display:none;" onclick="restartGame()">ÿßÿ®ÿØÿ£ ŸÖŸÜ ÿ¨ÿØŸäÿØ</button>
    <button class="btn golden-btn" id="insightBtn" onclick="showInsightReport()" style="margin-top: 10px; font-size: 1.1rem;">...</button>



    <div id="countdown" class="countdown-animate">ÿßŸÜÿ™ÿ∏ÿ± 5 ÿ´ŸàÿßŸÜŸä...</div>
  </div>
  
  

  <div id="playerStats" class="welcome-screen" style="display:none;">
    <div class="welcome-card">
      <p id="statsText">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®:</p>
      <div id="statsContent"></div>
      <button class="btn" id="backBtn" onclick="closeStats()">üîô ÿ±ÿ¨Ÿàÿπ</button>
    </div>
  </div>
  

  <div class="welcome-screen hidden fade-in" id="insightScreen">
    <div id="insightWrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;">
      <div id="insightAiBubble" class="ai-bubble show" style="width:120px;height:120px;">
        <div class="bubble-inner" style="width:100%;height:100%;">
          <img id="insightAiAvatar" src="assets/ai_default.png" alt="AI" style="width:90px;height:90px;"/>
          <div class="ai-dots"><span></span><span></span><span></span></div>
        </div>
      </div>
      <div id="insightAiBoard" class="show" style="background: white;padding: 20px;border-radius: 20px;box-shadow: 0 4px 12px rgba(0,0,0,0.1);width: 90%;max-width: 400px;height: 220px;display: flex;align-items: center;justify-content: center;overflow: hidden;">
        <div id="insightAiText" style="font-size:1.2rem;color:#2196F3;line-height:1.5;text-align:center;"></div>
      </div>
      <button id="shareInsightBtn" class="welcome-btn hidden" onclick="shareInsight()">üîó ÿ¥ÿßÿ±ŸÉ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸÖÿπ ÿµÿ≠ÿßÿ®ŸÉ</button>
      <button onclick="closeInsight()" class="welcome-btn hidden" id="closeInsightBtn">üèÅ ŸÉŸÅÿßŸäÿ© ÿ™ÿ≠ŸÑŸäŸÑ.. ŸÜÿ±ÿ¨ÿπÿü</button>
    </div>
  </div>

  

  <div id="aiFlash"></div>
  <script>

function reloadAIResponses() {
  try {
    const savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
    const lang = savedData.language || "ar";
    const gender = savedData.gender || "male";

    // ŸÜÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸÇÿ∑ ÿßŸÑŸÑÿ∫ÿ© + ÿßŸÑŸÜŸàÿπ ÿ®ÿØŸàŸÜ ÿßŸÑÿ≥ŸÜ
    const playerType = `${lang}_${gender}`;

    console.log("üîÅ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¨ŸÖŸÑ ŸÑŸÄ:", playerType);

    if (!window.allAIResponses) {
      console.error("‚ùå allAIResponses ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ");
      window.aiReady = false;
      return;
    }

    if (window.allAIResponses[playerType]) {
      window.aiResponses = window.allAIResponses[playerType];
      window.aiReady = true;
      console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ", Object.keys(aiResponses).length, "ÿ¨ŸÖŸÑ ÿ™ŸÅÿßÿπŸÑŸäÿ©");
    } else {
      console.error("‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ ÿ±ÿØŸàÿØ ŸÑŸÑŸÜŸàÿπ:", playerType);
      window.aiReady = false;
    }
  } catch (error) {
    console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä reloadAIResponses:", error);
    window.aiReady = false;
  }
}




function setupButtonSounds() {
  // ÿ±ÿ®ÿ∑ ÿßŸÑÿµŸàÿ™ ÿ®ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
  document.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', () => {
      SoundManager.play('buttonClick');
    });
  });
  
  // ÿ±ÿ®ÿ∑ ÿßŸÑÿµŸàÿ™ ÿ®ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ£ÿÆÿ±Ÿâ ÿßŸÑÿ™Ÿä ÿ™ÿ™ÿµÿ±ŸÅ ŸÖÿ´ŸÑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
  document.querySelectorAll('[onclick]').forEach(el => {
    if (el.tagName !== 'BUTTON') {
      el.addEventListener('click', () => {
        SoundManager.play('buttonClick');
      });
    }
  });
}





    </script>
    

    <!-- AI Reaction Elements -->




  <script>

    // ÿØÿßŸÑÿ© ÿ∞ŸÉŸäÿ© ÿ™ÿ™ÿπŸÇÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸÇÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
document.addEventListener('click', function(event) {
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ ÿπŸÑŸäŸá ÿ≤ÿ± ÿ£Ÿà ŸÑŸá ÿÆÿßÿµŸäÿ© onclick
  if (event.target.tagName === 'BUTTON' || event.target.hasAttribute('onclick')) {
    // ÿ™ÿ¨ŸÜÿ® ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿµŸàÿ™ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸÜÿ®ÿ´ŸÇŸãÿß ŸÖŸÜ ÿπŸÜÿµÿ± ÿ¢ÿÆÿ±
    if (!event.target.classList.contains('no-sound')) {
      SoundManager.play('buttonClick');
    }
  }
});
    // ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä ŸÑŸÑÿπÿ®ÿ© Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ±
    // ŸÅŸÇÿ∑ Ÿäÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© showAIReaction ŸÑÿ™ÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
    
    let messageQueue = [];
    let isShowingMessage = false;

    function showAIReaction(eventType) {
  console.log("üî• ÿ≠ÿØÿ´ AI ŸÖÿ∑ŸÑŸàÿ®:", eventType);
  if (eventType === 'lateOpen') {
   showSingleAIReaction('lateOpen');
}

  messageQueue.push(eventType);
  if (!isShowingMessage) {
    processMessageQueue();
  }
}



function processMessageQueue() {
  if (messageQueue.length === 0) {
    isShowingMessage = false;
    return;
  }

  isShowingMessage = true;
  const eventType = messageQueue.shift();
  showSingleAIReaction(eventType);
}


function showSingleAIReaction(eventType) {
  console.log("üîµ ÿØÿßÿÆŸÑ showSingleAIReaction ŸÑŸÑÿ≠ÿØÿ´:", eventType);

  const aiBubble = document.getElementById("aiBubble");
  const aiBoard = document.getElementById("aiBoard");
  const avatarImg = document.getElementById("aiAvatar");
  const aiText = document.getElementById("aiText");
  const heatBar = document.getElementById("aiHeatBar");

  // üñºÔ∏è ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿØÿ´
  switch (eventType) {
    case "idle":
      avatarImg.src = "assets/ai_thinking.png";
      break;
    case "combo":
      avatarImg.src = "assets/ai_happy.png";
      break;
    case "lineClear":
      avatarImg.src = "assets/ai_smile.png";
      break;
    case "nearLose":
      avatarImg.src = "assets/ai_worried.png";
      break;
    case "angry":
      avatarImg.src = "assets/ai_angry.png";
      break;
    case "shocked":
      avatarImg.src = "assets/ai_shocked.png";
      break;
    case "embarrassed":
      avatarImg.src = "assets/ai_embarrassed.png";
      break;
    default:
      avatarImg.src = "assets/ai_default.png";
  }
// ÿßŸáÿ™ÿ≤ÿßÿ≤ ÿπŸÜÿØ ÿßŸÑÿ∫ÿ∂ÿ® ÿ£Ÿà ÿßŸÑŸÇŸÑŸÇ
if (eventType === "angry" || eventType === "nearLose") {
  avatarImg.classList.add("shake");
  setTimeout(() => {
  // ŸÜÿ∂ŸäŸÅ ÿ≤ÿ±ÿßÿ± ÿ¨ÿØŸäÿØ ÿ¥ŸäŸÉ ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
  const avatarWrapper = document.getElementById("avatarWrapper");
  const startBtn = document.createElement("button");
  startBtn.innerText = lang === "ar" ? "üéÆ ŸäŸÑÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©!" : "üéÆ Let's Start!";
  startBtn.className = "welcome-btn";
  startBtn.style.marginTop = "20px";
  startBtn.onclick = () => {

    switchScreen("menu");
  };
  avatarWrapper.appendChild(startBtn);
}, 1500);

}

  const message = getRandomAIResponse(eventType);
  console.log("üü° ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÑŸä ÿ∑ŸÑÿπÿ™:", message);

  if (message) {
    showReactionMessage(message);
  } else {
    console.log("üö® ŸÖŸÅŸäÿ¥ ÿ±ÿ≥ÿßŸÑÿ© ÿ∑ŸÑÿπÿ™ ŸÑŸÑÿ≠ÿØÿ´:", eventType);
  }
}




    // ÿ®ÿßŸÇŸä ŸÉŸàÿØ ÿßŸÑŸÑÿπÿ®ÿ© Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ±
  

    const gameTranslations = {
      ar: {
        startBtn: "ÿßÿ®ÿØÿ£ ÿ±ÿ≠ŸÑÿ™Ÿä",
        statsBtn: "üìà ÿ®ŸäÿßŸÜÿßÿ™Ÿä",
        scoreText: "ÿßŸÑŸÜŸÇÿßÿ∑: ",
        gameOver: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©",
        resumeBtn: "ÿßÿ≥ÿ™ŸÉŸÖŸÑ ÿßŸÑŸÑÿπÿ® (ÿ•ÿπŸÑÿßŸÜ)",
        restartBtn: "ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©",
        countdownText: "ÿ£Ÿà ÿßŸÜÿ™ÿ∏ÿ± 5 ÿ´ŸàÿßŸÜŸä...",
        aiThinking: "ü§ñ ŸäŸÅŸÉÿ±...",
        statsTitle: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®",
        backBtn: "üîô ÿ±ÿ¨Ÿàÿπ",
        levelMessage: "ŸÖÿ≥ÿ™ŸàÿßŸÉ: ÿπÿßŸÑŸÖŸä"
      },
      en: {
        startBtn: "Start My Journey",
        statsBtn: "üìà My Stats",
        scoreText: "Score: ",
        gameOver: "Game Over",
        resumeBtn: "Resume Game (Ad)",
        restartBtn: "Start New Game",
        countdownText: "Or wait 5 seconds...",
        aiThinking: "ü§ñ Thinking...",
        statsTitle: "Player Stats",
        backBtn: "üîô Back",
        levelMessage: "Your Level: Pro"
      }
    };

    let gridCells = [], shapesInHand = [], shapesUsed = 0, score = 0;
    let difficultyLevel = 1;
    let floatingStartX = 0, floatingStartY = 0, pointerStartX = 0, pointerStartY = 0;
    let aiInternalNotes = [];
let isSoundOn = true; // ‚Üê Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± ŸáŸÜÿß
    let aiMemory = {
      context: [],
      mood: "neutral",
      lastEvent: null,
      intensity: 0
    };

    let playerBehavior = {
  fastMoves: 0,
  slowMoves: 0,
  perfectClears: 0,
  nearFails: 0,
  lastMoveTime: null,
  avgSpeed: 0,
  totalMoves: 0,
  failedAttempts: 0,
  lastShapeCode: null,
  repeatedShapeCount: 0
};


    let currentShape = null, sourceElement = null, floating = null;
    let offset = { x: 0, y: 0 }, resumed = false, monitorInterval = null;

    const grid = document.getElementById("grid");
    const shapesDiv = document.getElementById("shapes");
    const scoreboard = document.getElementById("scoreboard");
    const finalScoreDisplay = document.getElementById("finalScoreDisplay");
    const resumeBtn = document.getElementById("resumeBtn");
    const restartBtn = document.getElementById("restartBtn");
    const countdownEl = document.getElementById("countdown");
/*** ÿßÿ®ÿØÿ£ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ***/
const canvas = document.querySelector('canvas');
if (canvas) {
  canvas.style.imageRendering = 'pixelated';
  canvas.style.transform = 'translateZ(0)';
}
/*** ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ∂ÿßŸÅ ***/
    const screens = {
      menu: document.getElementById("menu"),
      game: document.getElementById("game"),
      gameover: document.getElementById("gameover")
    };

    const weightedShapes = [
  { shape: [[0,0]], weight: 1 }, // ŸÜŸÇÿ∑ÿ© Ÿàÿßÿ≠ÿØÿ©
  { shape: [[0,0],[1,0]], weight: 1 }, // ÿÆÿ∑ ÿ±ÿ£ÿ≥Ÿä ŸÖŸÉŸàŸÜ ŸÖŸÜ ŸÜŸÇÿ∑ÿ™ŸäŸÜ
  { shape: [[0,0],[0,1]], weight: 1 }, // ÿÆÿ∑ ÿ£ŸÅŸÇŸä ŸÖŸÉŸàŸÜ ŸÖŸÜ ŸÜŸÇÿ∑ÿ™ŸäŸÜ
  { shape: [[0,0],[1,0],[0,1]], weight: 1 }, // ÿ¥ŸÉŸÑ L ÿµÿ∫Ÿäÿ±
  { shape: [[0,0],[1,0],[2,0]], weight: 4 }, // ÿÆÿ∑ ÿ±ÿ£ÿ≥Ÿä ŸÖŸÉŸàŸÜ ŸÖŸÜ 3 ŸÜŸÇÿßÿ∑
  { shape: [[0,0],[0,1],[0,2]], weight: 4 }, // ÿÆÿ∑ ÿ£ŸÅŸÇŸä ŸÖŸÉŸàŸÜ ŸÖŸÜ 3 ŸÜŸÇÿßÿ∑
  { shape: [[0,0],[1,0],[1,1]], weight: 2 }, // ÿ¥ŸÉŸÑ ÿ≤ÿßŸàŸäÿ© ŸäŸÖŸäŸÜ ÿ™ÿ≠ÿ™
  { shape: [[0,0],[0,1],[1,1]], weight: 2 }, // ÿ¥ŸÉŸÑ ÿ≤ÿßŸàŸäÿ© Ÿäÿ≥ÿßÿ± ÿ™ÿ≠ÿ™
  { shape: [[0,0],[1,0],[2,0],[0,1],[1,1],[2,1]], weight: 7 }, // ŸÖÿ≥ÿ™ÿ∑ŸäŸÑ 2x3
  { shape: [[0,0],[1,0],[2,0],[1,1]], weight: 1 }, // ÿ¥ŸÉŸÑ T ŸÖŸÇŸÑŸàÿ®
  { shape: [[0,0],[0,1],[1,1],[2,1]], weight: 2 }, // ÿ¥ŸÉŸÑ ÿ≥ŸáŸÖ ŸÑŸÑŸäŸÖŸäŸÜ
  { shape: [[0,0],[1,0],[2,0],[3,0]], weight: 3 }, // ÿÆÿ∑ ÿ±ÿ£ÿ≥Ÿä ÿ∑ŸàŸäŸÑ 4 ŸÜŸÇÿßÿ∑
  { shape: [[0,0],[0,1],[0,2],[0,3]], weight: 3 }, // ÿÆÿ∑ ÿ£ŸÅŸÇŸä ÿ∑ŸàŸäŸÑ 4 ŸÜŸÇÿßÿ∑
  { shape: [[0,0],[1,0],[0,1],[1,1]], weight: 7 }, // ŸÖÿ±ÿ®ÿπ 2x2
  { shape: [[0,0],[1,0],[2,0],[0,1],[1,1],[2,1],[0,2],[1,2],[2,2]], weight: 7 }, // ŸÖÿ±ÿ®ÿπ 3x3
  { shape: [[0,0],[0,1],[0,2],[1,2],[2,2]], weight: 1 }, // ÿ¥ŸÉŸÑ L ŸÖÿπŸÉŸàÿ≥ ŸÉÿ®Ÿäÿ±
  { shape: [[0,0],[2,0],[0,1],[2,1],[0,2],[1,2],[2,2]], weight: 0.5 }, // ÿ¥ŸÉŸÑ U
  { shape: [[0,0],[1,0],[2,0],[1,1],[1,2]], weight: 2 }, // ÿ¥ŸÉŸÑ +
  { shape: [[0,0],[1,0],[1,1],[1,2],[2,2]], weight: 0.5 }, // ÿ¥ŸÉŸÑ S ŸÖÿßÿ¶ŸÑ
  { shape: [[0,0],[0,1],[1,1],[1,2],[2,2]], weight: 0.5 }  // ÿ¥ŸÉŸÑ Z ŸÖÿßÿ¶ŸÑ
];


    function switchScreen(screen) {
      
      Object.values(screens).forEach(s => s.classList.remove("active"));
      screens[screen].classList.add("active");
    }

    function startGame() {
      gameStartTime = Date.now();

      if (!window.aiReady) {
  console.log("ŸÑÿ≥Ÿá ŸÖÿ≥ÿ™ŸÜŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¨ŸÖŸÑ...");
  setTimeout(startGame, 100);
  
  clearPreview();
  shapesDiv.innerHTML = "";
  return;
}

      resumed = false;
      let oldBehavior = JSON.parse(localStorage.getItem("blockBehavior") || "{}");
      if (oldBehavior.totalMoves) playerBehavior = oldBehavior;

      switchScreen("game");
      grid.innerHTML = "";
      gridCells = [];
      for (let i = 0; i < 64; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        grid.appendChild(cell);
        gridCells.push(cell);
      }
      score = 0;
      shapesUsed = 0;
      updateScore();
      generateSmartShapes();
      startMonitor();
    
     // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑÿ≥Ÿäÿ° ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÑÿπÿ® (ŸÜÿ≥ÿÆÿ© ŸÖÿπÿØŸëŸÑÿ©)
setTimeout(() => {
  const checkBadPerformance = setInterval(() => {
    const elapsed = Date.now() - gameStartTime;
    console.log("‚è± ŸàŸÇÿ™ ÿßŸÑŸÑÿπÿ®:", elapsed, "üìâ ÿßŸÑŸÜŸÇÿßÿ∑:", score, "üî• ŸÉŸÖÿ®Ÿà:", playerBehavior.perfectClears);
    if (score < 350 && elapsed > 25000 && playerBehavior.perfectClears === 0) {
      showAIReaction("embarrassed");
      clearInterval(checkBadPerformance);
    }
  }, 5000);
}, 10000);
document.body.addEventListener('touchstart', () => {
  if (SoundManager.context?.state === 'suspended') {
    SoundManager.context.resume();
  }
}, { once: true });

    }

    function restartGame() {
      clearInterval(monitorInterval);
      startGame();
    }

    function updateScore() {
      scoreboard.textContent = `Score: ${score}`;
      let smartFactor = 0;
if (playerBehavior.avgSpeed && playerBehavior.avgSpeed < 2000) smartFactor += 1;
if (playerBehavior.perfectClears >= 5) smartFactor += 1;
if (playerBehavior.nearFails === 0 && score > 800) smartFactor += 1;
difficultyLevel = 1 + smartFactor * 0.7; // ÿ™ŸÇŸÑŸäŸÑ Ÿàÿ™Ÿäÿ±ÿ© ÿßŸÑÿ™ÿµÿßÿπÿØ

    }

    function xyToIndex(x, y) {
      return y * 8 + x;
    }

    function canPlace(shape, x, y) {
      return shape.every(([dx, dy]) => {
        const gx = x + dx, gy = y + dy;
        return gx >= 0 && gx < 8 && gy >= 0 && gy < 8 &&
          !gridCells[xyToIndex(gx, gy)].classList.contains("filled");
      });
    }

    function canShapeFitAnywhere(shape) {
      for (let y = 0; y < 8; y++) {
        for (let x = 0; x < 8; x++) {
          if (canPlace(shape, x, y)) return true;
        }
      }
      return false;
    }

    function rotateShape(shape, times = 1) {
      let result = shape.map(([x, y]) => [x, y]);
      for (let t = 0; t < times; t++) {
        result = result.map(([x, y]) => [y, -x]);
        const minX = Math.min(...result.map(([x]) => x));
        const minY = Math.min(...result.map(([_, y]) => y));
        result = result.map(([x, y]) => [x - minX, y - minY]);
      }
      return result;
    }

    function createShapeElement(shape) {
      
      const el = document.createElement("div");
      el.className = "shape";

      const minX = Math.min(...shape.map(([x]) => x));
      const minY = Math.min(...shape.map(([_, y]) => y));

      shape.forEach(([x, y]) => {
        const block = document.createElement("div");
        block.className = "block";
        block.style.gridColumn = (x - minX + 1);
        block.style.gridRow = (y - minY + 1);
        el.appendChild(block);
      });

      el.dataset.shape = JSON.stringify(shape);
      return el;
    }

    function getRandomWeightedShape() {
      let filtered = weightedShapes.filter(s => s.shape.length <= (5 + difficultyLevel));
      let totalWeight = filtered.reduce((sum, s) => sum + s.weight, 0);
      let rand = Math.random() * totalWeight;
      for (let s of filtered) {
        if (rand < s.weight) return s.shape;
        rand -= s.weight;
      }
    }

    function generateSmartShapes() {
      shapesDiv.innerHTML = "";
      shapesUsed = 0;
      shapesInHand = [];
      let tries = 0;
      const shape = getRandomWeightedShape();

      while (shapesInHand.length < 3 && tries < 100) {
        let shape = getRandomWeightedShape();
        let rotation = Math.floor(Math.random() * 4);
        shape = rotateShape(shape, rotation);

        if (Math.random() < 10 && isLineClearShape(shape)) {
  shapesInHand.push(shape);
  continue;
}


function isLineClearShape(shape) {
  const xs = shape.map(([x, _]) => x);
  const ys = shape.map(([_, y]) => y);
  const uniqueX = new Set(xs).size;
  const uniqueY = new Set(ys).size;

  return uniqueX === 1 || uniqueY === 1 || shape.length === 4 || shape.length === 9; // ÿÆÿ∑Ÿàÿ∑ ÿ£Ÿà ŸÖÿ±ÿ®ÿπÿßÿ™
}



        if (canShapeFitAnywhere(shape)) {
          shapesInHand.push(shape);
        }
        tries++;
      }

      shapesInHand.forEach(shape => {
        const el = createShapeElement(shape);
        shapesDiv.appendChild(el);

        el.addEventListener("pointerdown", e => {
          SoundManager.play('shapePick');
          e.preventDefault();
          sourceElement = el;
          const rect = el.getBoundingClientRect();
          const cellSize = gridCells[0].getBoundingClientRect().width;
          offset.x = e.clientX - rect.left;
          offset.y = e.clientY - rect.top;

          pointerStartX = e.pageX;
          pointerStartY = e.pageY;

          floatingStartX = e.pageX;
          floatingStartY = e.pageY - (cellSize * 4);

          currentShape = shape;
          floating = el.cloneNode(true);
          floating.classList.add("floating");
          floating.style.width = `${cellSize * 4}px`;
          floating.style.height = `${cellSize * 4}px`;
          floating.style.left = (floatingStartX - offset.x) + "px";
          floating.style.top = (floatingStartY - offset.y) + "px";

          el.style.visibility = "hidden";
          document.body.appendChild(floating);
          playerBehavior.failedAttempts++;
console.log("üìõ ŸÖÿ≠ÿßŸàŸÑÿ© ŸÅÿßÿ¥ŸÑÿ© ÿ±ŸÇŸÖ:", playerBehavior.failedAttempts);

        });
      });
      
    }

    function placeShape(shape, x, y) {
      shape.forEach(([dx, dy]) => {
        gridCells[xyToIndex(x+dx, y+dy)].classList.add("filled");
      });
      score += shape.length * 10;
      checkFullLines();
      updateScore();
      shapesUsed++;

      let now = Date.now();
      if (playerBehavior.lastMoveTime) {
        let delta = now - playerBehavior.lastMoveTime;
        playerBehavior.totalMoves++;
        if (delta < 3000) playerBehavior.fastMoves++;
        else playerBehavior.slowMoves++;
        playerBehavior.avgSpeed = (playerBehavior.avgSpeed * (playerBehavior.totalMoves - 1) + delta) / playerBehavior.totalMoves;
      }
      playerBehavior.lastMoveTime = now;

      if (score > 700 && playerBehavior.fastMoves > playerBehavior.slowMoves) {
        aiInternalNotes.push(`ÿßŸÑŸÑÿßÿπÿ® ÿ≥ÿ±Ÿäÿπ ŸàÿπÿØŸàÿßŸÜŸä... ÿßÿ≠ÿ™ŸÖÿßŸÑ ŸÉÿ®Ÿäÿ± ŸäŸàÿµŸÑ ŸÑÿ£ÿ±ŸÇÿßŸÖ ÿπÿßŸÑŸäÿ©.`);
      }
      if (playerBehavior.nearFails >= 3) {
        aiInternalNotes.push(`ÿßŸÑŸÑÿßÿπÿ® ÿ®ŸäŸÜŸáÿßÿ± ÿ®ÿ≥ŸáŸàŸÑÿ©... ŸÖÿ≠ÿ™ÿßÿ¨ ÿ™ÿ≠ŸÅŸäÿ≤ ŸÖÿÆÿ™ŸÑŸÅ.`);
      }
      if (score > 1000 && playerBehavior.perfectClears > 5) {
        aiInternalNotes.push(`ÿßŸÑŸÖŸáÿßÿ±ÿßÿ™ ÿ®ÿØÿ£ÿ™ ÿ™ÿ∏Ÿáÿ± ÿ®Ÿàÿ∂Ÿàÿ≠... ŸÑÿßÿ≤ŸÖ ÿ£ÿ±ŸÅÿπ ÿßŸÑÿ™ÿ≠ÿØŸä.`)
      }
// ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ¥ŸÉŸÑ
const shapeCode = JSON.stringify(shape);
if (playerBehavior.lastShapeCode === shapeCode) {
  playerBehavior.repeatedShapeCount++;
} else {
  playerBehavior.repeatedShapeCount = 0;
}
playerBehavior.lastShapeCode = shapeCode;

// ŸÑŸà ŸÉÿ±ÿ± ŸÜŸÅÿ≥ ÿßŸÑÿ¥ŸÉŸÑ ŸÉÿ™Ÿäÿ±
if (playerBehavior.repeatedShapeCount >= 3) {
  showAIReaction('angry');
  playerBehavior.repeatedShapeCount = 0;
}

// ŸÑŸà ÿ≠ÿßŸàŸÑ ŸàŸÅÿ¥ŸÑ ŸÉÿ™Ÿäÿ± ŸÇÿ®ŸÑ ÿßŸÑŸÜÿ¨ÿßÿ≠
if (playerBehavior.failedAttempts >= 3) {
  showAIReaction('angry');
  playerBehavior.failedAttempts = 0;
} else {
  playerBehavior.failedAttempts = 0; // ÿ™ŸÖ ÿßŸÑŸÜÿ¨ÿßÿ≠ÿå ŸÜÿ®ÿØÿ£ ŸÖŸÜ ÿ¨ÿØŸäÿØ
}

      if (shapesUsed >= 3) {
        generateSmartShapes();
      }
    }
// ÿ∂ÿπ Ÿáÿ∞ÿß ÿ®ÿØŸÑÿßŸã ŸÖŸÜ gameLoop ÿßŸÑŸÇÿØŸäŸÖ
function runGame() {
  // ÿ£ŸÉŸàÿßÿØ ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸáŸÜÿß
  if (!document.hidden) {
    setTimeout(runGame, 1000/60); // 60 FPS
  }
}
runGame();

    function checkFullLines() {
  let clearedRows = [], clearedCols = [];

  // ŸÉŸàÿØ ÿßŸÑŸÉÿ¥ŸÅ ÿπŸÜ ÿßŸÑÿµŸÅŸàŸÅ ŸàÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑŸÖŸÖÿ™ŸÑÿ¶ÿ© Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà
  for (let row = 0; row < 8; row++) {
    if ([...Array(8)].every((_, col) => gridCells[xyToIndex(col, row)].classList.contains("filled"))) {
      clearedRows.push(row);
    }
  }

  for (let col = 0; col < 8; col++) {
    if ([...Array(8)].every((_, row) => gridCells[xyToIndex(col, row)].classList.contains("filled"))) {
      clearedCols.push(col);
    }
  }

  if (clearedRows.length || clearedCols.length) {
    // ÿ£ÿ∂ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ¨ÿØŸäÿØ ŸáŸÜÿß ‚Üì
    const totalCleared = clearedRows.length + clearedCols.length;
    
    // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®
    if (totalCleared >= 2) {
      SoundManager.play('comboClear');
    } else {
      SoundManager.play('singleClear');
    }

    // ÿ®ÿßŸÇŸä ÿßŸÑŸÉŸàÿØ Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà ‚Üì
    clearedRows.forEach(row => {
      for (let col = 0; col < 8; col++) gridCells[xyToIndex(col, row)].classList.remove("filled");
    });

    clearedCols.forEach(col => {
      for (let row = 0; row < 8; row++) gridCells[xyToIndex(col, row)].classList.remove("filled");
    });

    score += totalCleared * 100;
    updateScore();

    setTimeout(() => {
      if (totalCleared >= 2) {
        showAIReaction('combo');
      } else {
        showAIReaction('lineClear');
      }
    }, 100);
  }
}

    function showGameOver() {


  clearInterval(monitorInterval);
  playerBehavior.nearFails++;

  switchScreen("gameover");

  finalScoreDisplay.classList.remove("show", "bounce-in");
  resumeBtn.style.display = "inline-block";
  resumeBtn.classList.add("golden-btn");
  restartBtn.style.display = "none";
  countdownEl.style.display = "block";

  // ŸÜÿµ ÿπÿßÿ∑ŸÅŸä ŸÖÿ®ÿ∑ŸÜ Ÿàÿ¨ÿ∞ÿßÿ®
  const motivationalMessages = [
    
  ];
  document.getElementById("motivationalText").textContent = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];

  startResumeCountdown();
  // üß† ÿ≠ŸÅÿ∏ ÿ£ÿØÿßÿ° ÿßŸÑÿ¨ŸàŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿßŸÑÿ≥ÿßÿÆÿ±ÿ©
  const history = JSON.parse(localStorage.getItem("playerHistory") || "[]");
history.push({
  score,
  fastMoves: playerBehavior.fastMoves,
  slowMoves: playerBehavior.slowMoves,
  perfectClears: playerBehavior.perfectClears,
  nearFails: playerBehavior.nearFails,
  failedAttempts: playerBehavior.failedAttempts || 0,
  totalMoves: playerBehavior.totalMoves,
  avgSpeed: playerBehavior.avgSpeed,
  duration: Date.now() - gameStartTime,
  mood: aiMemory.mood || "neutral",
  shapeRepeats: playerBehavior.repeatedShapeCount || 0
});
if (history.length > 10) history.shift(); // ŸÜÿ≠ÿ™ŸÅÿ∏ ÿ®ÿ¢ÿÆÿ± 10 ÿ¨ŸàŸÑÿßÿ™
localStorage.setItem("playerHistory", JSON.stringify(history));

}



function resumeGame() {
  // Ÿáÿ∞ÿß ŸÖŸÉÿßŸÜ Ÿàÿ∂ÿπ ŸÉŸàÿØ AdMob ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÑÿßÿ≠ŸÇÿßŸã
  // ÿßŸÑŸÖÿ´ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä ÿ¨ÿßŸáÿ≤ ŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸá ÿ®ŸÄ AdMob Rewarded Ad
  
  // 1. ŸáŸÜÿß ÿ≥ÿ™ÿ∂ÿπ ŸÉŸàÿØ ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÖŸÉÿßŸÅÿ¶ (AdMob)
  // 2. ÿπŸÜÿØ ÿßŸÉÿ™ŸÖÿßŸÑ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿå Ÿäÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑŸÉŸàÿØ ÿØÿßÿÆŸÑ onAdWatched()
  
  // ŸÖÿ≠ÿßŸÉÿßÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜ (ÿßÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿπŸÜÿØ ÿØŸÖÿ¨ AdMob ÿßŸÑŸÅÿπŸÑŸä)
  const onAdWatched = () => {
    // ŸÉŸàÿØ ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ ÿßŸÑŸÑÿπÿ® ÿßŸÑŸÅÿπŸÑŸä
    clearInterval(countdownTimer);
    clearPreview();
    
    // ŸÖÿ≥ÿ≠ ÿ£Ÿä ÿ£ÿ¥ŸÉÿßŸÑ ŸÖÿ™ÿ®ŸÇŸäÿ©
    shapesDiv.innerHTML = "";
    
    // ŸÖÿ≥ÿ≠ ÿ®ÿπÿ∂ ÿßŸÑÿÆŸÑÿßŸäÿß ÿπÿ¥Ÿàÿßÿ¶ŸäÿßŸã (ŸÖÿ´ÿßŸÑ: 5 ÿÆŸÑÿßŸäÿß)
    let cellsCleared = 0;
    while (cellsCleared < 5) {
      const randomCell = Math.floor(Math.random() * gridCells.length);
      if (gridCells[randomCell].classList.contains("filled")) {
        gridCells[randomCell].classList.remove("filled");
        cellsCleared++;
      }
    }
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ
    generateSmartShapes();
    
    // ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÑÿπÿ®
    switchScreen("game");
    
    // ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ŸÖŸÜ ÿ¨ÿØŸäÿØ
    startMonitor();
  };
  
  // ŸÖÿ≠ÿßŸÉÿßÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ (ÿßÿ≥ÿ™ÿ®ÿØŸÑ Ÿáÿ∞ÿß ÿ® AdMob)
  onAdWatched(); // ÿßÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± ÿπŸÜÿØ ÿØŸÖÿ¨ AdMÿ®
  
  // ŸÉŸàÿØ AdMob ÿßŸÑŸÖÿ´ÿßŸÑ (ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ•ÿ∂ÿßŸÅÿ©):
  /*
  if(window.admob) {
    admob.rewarded.load().then(() => {
      return admob.rewarded.show();
    }).then(() => {
      onAdWatched();
    }).catch(err => {
      console.log("Error showing ad:", err);
    });
  }
  */
}

// ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜ (ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑÿ±ÿ®ÿ∑Ÿáÿß ÿ®AdMob ŸÑÿßÿ≠ŸÇÿßŸã)
function showRewardedAdWithCallback(callback) {
  // ÿ¨ÿßŸáÿ≤ÿ© ŸÑÿØŸÖÿ¨ AdMob ŸÖÿ®ÿßÿ¥ÿ±ÿ©
  callback(); // ÿßÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± ÿπŸÜÿØ ÿØŸÖÿ¨ AdMob
  
  // ŸÜŸÖŸàÿ∞ÿ¨ ŸÉŸàÿØ AdMob:
  /*
  return new Promise((resolve) => {
    if(window.admob) {
      admob.rewarded.load().then(() => {
        return admob.rewarded.show();
      }).then(() => {
        callback();
        resolve(true);
      }).catch(err => {
        console.log("Error showing ad:", err);
        resolve(false);
      });
    } else {
      resolve(false);
    }
  });
  */
}



function showRewardedAd(callback) {
  // Ÿáÿ∞ÿß ŸÖŸÉÿßŸÜ ÿ±ÿ®ÿ∑ ÿ•ÿπŸÑÿßŸÜ AdMob ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÑÿßÿ≠ŸÇŸãÿß
  console.log("üì∫ ÿπÿ±ÿ∂ ÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©");
  
  // ŸÑŸÖÿ≠ÿßŸÉÿßÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ (ŸÑŸÑÿ™ÿ∑ŸàŸäÿ± ŸÅŸÇÿ∑)
  const adShown = confirm("Ÿáÿ∞ÿß ŸÖŸÉÿßŸÜ ÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü");
  
  if (adShown) {
    if (callback) callback();
    return true;
  }
  return false;
}

function generateInsightReport() {
  const textArea = document.getElementById("insightAiText");
  const avatar = document.getElementById("insightAiAvatar");
  const dots = document.querySelector("#insightAiBubble .ai-dots");
  const shareBtn = document.getElementById("shareInsightBtn");
  const closeBtn = document.getElementById("closeInsightBtn");

  shareBtn.classList.add("hidden");
  closeBtn.classList.add("hidden");
  shareBtn.classList.remove("visible");
  closeBtn.classList.remove("visible");

  const b = playerBehavior;
  const mood = aiMemory?.mood || "neutral";
  const lang = JSON.parse(localStorage.getItem("blockPlayerData"))?.language || 'ar';
  const ai = window.aiResponses?.insightBlocks || {};
  const rand = arr => arr[Math.floor(Math.random() * arr.length)];
  const report = [];

  // 1. ŸÖŸÇÿØŸÖÿ© ÿ¨ÿßÿØÿ© ÿ™ÿ≠ŸÑŸäŸÑŸäÿ©
  if (ai.opening?.length) report.push("üß† " + rand(ai.opening));

  // 2. ÿ™ÿ≠ŸÑŸäŸÑ ÿ£ÿØÿßÿ° (ÿ≠ÿ≥ÿ® ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨)
  if (b.score > 4000 && ai.analysis_strong?.length) {
    report.push("üìä " + rand(ai.analysis_strong));
  } else if (b.score < 1000 && ai.analysis_weak?.length) {
    report.push("üìâ " + rand(ai.analysis_weak));
  } else if (ai.analysis_neutral?.length) {
    report.push("üìà " + rand(ai.analysis_neutral));
  }

  // 3. ÿ™ÿ≠ŸÑŸäŸÑ ŸÜŸÅÿ≥Ÿä (ÿ≠ÿ≥ÿ® ÿßŸÑÿ≥ŸÑŸàŸÉ)
  if (b.repeatedShapeCount > 3 && ai.emotion_stubborn?.length) {
    report.push("üß± " + rand(ai.emotion_stubborn));
  } else if (b.failedAttempts > 4 && ai.emotion_nervous?.length) {
    report.push("üò∞ " + rand(ai.emotion_nervous));
  } else if (b.slowMoves > b.fastMoves && ai.emotion_hesitant?.length) {
    report.push("üê¢ " + rand(ai.emotion_hesitant));
  } else if (ai.emotion_generic?.length) {
    report.push("üåÄ " + rand(ai.emotion_generic));
  }

  // 4. ÿØÿπŸÖ ÿπÿßÿ∑ŸÅŸä ÿ≠ŸÇŸäŸÇŸä (ŸÑŸà ŸÅÿπŸÑÿßŸã Ÿäÿ≥ÿ™ÿ≠ŸÇ)
  if ((b.perfectClears >= 1 || b.gamesPlayed >= 4 || b.failedAttempts >= 5) && ai.support?.length) {
    report.push("üíô " + rand(ai.support));
  }

  // 5. ÿØÿπŸàÿ© ŸÑŸÑÿ™ÿ≠ÿØŸä ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÖÿ≤ÿßÿ¨ ÿßŸÑÿ≠ÿßŸÑŸä ŸÑŸÑÿÆÿµŸÖ
  if (mood === "confident" && ai.challenge_strong?.length) {
    report.push("üî• " + rand(ai.challenge_strong));
  } else if (ai.challenge_neutral?.length) {
    report.push("üéØ " + rand(ai.challenge_neutral));
  }

  // 6. ÿ™ÿ¥ÿ®ŸäŸá ÿÆÿ™ÿßŸÖŸä ÿ∫ÿ±Ÿäÿ®
  if (ai.closing?.length) {
    report.push("üåÄ " + rand(ai.closing));
  }

  const message = "üìò ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ®Ÿäÿ∂ÿ© ÿßŸÑŸÖÿ≤ÿ±ŸÇÿ¥ÿ©:\n\n" + report.join("\n\n");

  textArea.textContent = "";
  dots.style.display = "flex";
  avatar.src = "assets/ai_thinking.png";

  setTimeout(() => {
    dots.style.display = "none";
    let i = 0;
    function typeChar() {
      if (i < message.length) {
        textArea.textContent += message[i++];
        setTimeout(typeChar, 35);
      } else {
        shareBtn.classList.remove("hidden");
        closeBtn.classList.remove("hidden");
        shareBtn.classList.add("visible");
        closeBtn.classList.add("visible");
        avatar.src = "assets/ai_smile.png";
        avatar.classList.add("bounce");
      }
    }
    typeChar();
  }, 1000);
    startAvatarIntroduction();
}



function showInsightReport() {
  // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© gameover ÿ£ŸàŸÑÿßŸã
  document.getElementById("gameover").classList.remove("active");
  
  // ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
  document.getElementById("insightScreen").classList.remove("hidden");
  
  // ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
  generateInsightReport();
  
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿ±ÿØŸàÿØ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπŸÖŸÑŸáÿß
  reloadAIResponses();
}


    function showAIMessage(text) {
      const aiText = document.getElementById("aiText");
      const heatBar = document.getElementById("aiHeatBar");
      aiText.textContent = text;
      aiText.classList.remove("show");
      heatBar.classList.remove("active");
      void aiText.offsetWidth;
      void heatBar.offsetWidth;
      aiText.classList.add("show");
      heatBar.classList.add("active");

      setTimeout(() => {
        aiText.classList.remove("show");
        heatBar.classList.remove("active");
      }, 3500);
    }

    function clearRandomLine() {
      const isRow = Math.random() < 0.5;
      const index = Math.floor(Math.random() * 8);
      if (isRow) {
        for (let col = 0; col < 8; col++) {
          gridCells[xyToIndex(col, index)].classList.remove("filled");
        }
      } else {
        for (let row = 0; row < 8; row++) {
          gridCells[xyToIndex(index, row)].classList.remove("filled");
        }
      }
    }

    function startMonitor() {
      clearInterval(monitorInterval);
      monitorInterval = setInterval(() => {
        const activeShapes = Array.from(shapesDiv.children).map(el => JSON.parse(el.dataset.shape || "[]"));
        const playable = activeShapes.some(shape => canShapeFitAnywhere(shape));
        if (!playable) {
          clearInterval(monitorInterval);
          showGameOver();
        
          if (Math.random() < 0.07 && aiInternalNotes.length > 0) {
            const secret = aiInternalNotes[Math.floor(Math.random() * aiInternalNotes.length)];
            showAIMessage(`ü§ñ (ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ∞ŸÉŸäÿ©): ${secret}`);
          }
        }
      }, 300);
    }

    function clearPreview() {
      gridCells.forEach(cell => {
        cell.classList.remove("preview");
        cell.classList.remove("line-clear-preview");
      });
    }

    function showPreview(shape, x, y) {
      clearPreview();
      const previewIndexes = [];

      shape.forEach(([dx, dy]) => {
        const gx = x + dx;
        const gy = y + dy;
        if (gx >= 0 && gx < 8 && gy >= 0 && gy < 8) {
          const index = xyToIndex(gx, gy);
          previewIndexes.push(index);
          gridCells[index].classList.add("preview");
        }
      });

      for (let row = 0; row < 8; row++) {
        if ([...Array(8)].every((_, col) => {
          const i = xyToIndex(col, row);
          return gridCells[i].classList.contains("filled") || previewIndexes.includes(i);
        })) {
          for (let col = 0; col < 8; col++) {
            gridCells[xyToIndex(col, row)].classList.add("line-clear-preview");
          }
        }
      }

      for (let col = 0; col < 8; col++) {
        if ([...Array(8)].every((_, row) => {
          const i = xyToIndex(col, row);
          return gridCells[i].classList.contains("filled") || previewIndexes.includes(i);
        })) {
          for (let row = 0; row < 8; row++) {
            gridCells[xyToIndex(col, row)].classList.add("line-clear-preview");
          }
        }
      }
    }

    window.addEventListener("pointermove", e => {
      if (floating) {
        const cellSize = gridCells[0].getBoundingClientRect().width;
        const moveX = (e.pageX - pointerStartX) * 1.3;
        const moveY = (e.pageY - pointerStartY) * 1.3;

        floating.style.left = (floatingStartX + moveX - offset.x) + "px";
        floating.style.top = (floatingStartY + moveY - offset.y) + "px";

        const rect = grid.getBoundingClientRect();
        const floatRect = floating.getBoundingClientRect();
        const gridX = Math.round((floatRect.left - rect.left) / (rect.width / 8));
        const gridY = Math.round((floatRect.top - rect.top) / (rect.height / 8));

        if (canPlace(currentShape, gridX, gridY)) {
          showPreview(currentShape, gridX, gridY);
        } else {
          clearPreview();
        }
      }
    });

    window.addEventListener("pointerup", e => {
      if (!floating || !currentShape) return;
      const rect = grid.getBoundingClientRect();
      const floatRect = floating.getBoundingClientRect();
      const gridX = Math.round((floatRect.left - rect.left) / (rect.width / 8));
      const gridY = Math.round((floatRect.top - rect.top) / (rect.height / 8));

      if (canPlace(currentShape, gridX, gridY)) {
        placeShape(currentShape, gridX, gridY);
        sourceElement.remove();
      } else {
        sourceElement.style.visibility = "visible";
      }

      floating.remove();
      floating = null;
      currentShape = null;
      sourceElement = null;
      clearPreview();
    });

   let playerData = {
  language: '',
  gender: ''
};


    function chooseLanguage(lang) {
  playerData.language = lang;
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));
  document.getElementById("step2").style.display = "none";
document.getElementById("welcomeText").style.display = "block";
document.getElementById("langButtons").style.display = "none";
document.getElementById("step2").style.display = "block";



  if(lang === 'en') {
    document.getElementById("welcomeText").innerText = "ü§ñ Hello! Let me know you better!";
    document.getElementById("genderText").innerText = "üë§ Are you a boy or a girl?";
    document.querySelectorAll("#step2 button")[0].innerText = "üöπ Boy";
    document.querySelectorAll("#step2 button")[1].innerText = "üö∫ Girl";

    document.getElementById("ageText").innerText = "üéÇ How old are you?";
    document.querySelectorAll("#step3 button")[0].innerText = "üî¢ Under 18";
    document.querySelectorAll("#step3 button")[1].innerText = "üî¢ Above 18";

    document.querySelector("#finalStep button").innerText = "üöÄ Let's Start The Journey!";
  } else {
    document.getElementById("welcomeText").innerText = "ü§ñ ÿ£ŸáŸÑÿßŸã! ÿÆŸÑŸäŸÜÿß ŸÜÿ™ÿπÿ±ŸÅ ÿπŸÑŸäŸÉ ÿ¥ŸàŸäÿ©!";
    document.getElementById("genderText").innerText = "üë§ ÿ•ŸÜÿ™ ŸàŸÑÿØ ŸàŸÑÿß ÿ®ŸÜÿ™ÿü";
    document.querySelectorAll("#step2 button")[0].innerText = "üöπ ŸàŸÑÿØ";
    document.querySelectorAll("#step2 button")[1].innerText = "üö∫ ÿ®ŸÜÿ™";

    document.getElementById("ageText").innerText = "üéÇ ÿπŸÖÿ±ŸÉ ÿ£ŸÇŸÑ ŸÖŸÜ 18 ŸàŸÑÿß ÿ£ŸÉÿ™ÿ±ÿü";
    document.querySelectorAll("#step3 button")[0].innerText = "üî¢ ÿ£ŸÇŸÑ ŸÖŸÜ 18";
    document.querySelectorAll("#step3 button")[1].innerText = "üî¢ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 18";

    document.querySelector("#finalStep button").innerText = "üöÄ ŸäŸÑÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©!";
  }

  applyLanguage(); // ‚Üê ÿ≥ÿ∑ÿ± ŸÖŸáŸÖ ÿ¨ÿØÿßŸã ŸÑÿ∂ŸÖÿßŸÜ ÿ™ÿ±ÿ¨ŸÖÿ© ÿ®ÿßŸÇŸä ÿßŸÑŸàÿßÿ¨Ÿáÿ©
}


function chooseGender(gender) {
  playerData.gender = gender;
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));

  document.getElementById("welcomeScreen").classList.add("hidden");
  document.getElementById("avatarIntroScreen").classList.remove("hidden");

  reloadAIResponses();

 reloadAIResponses();
setTimeout(() => {
  if (window.aiReady) {
  showReactionMessage(getAvatarWelcomeMessage());


  }
}, 100);

}





 function getAvatarWelcomeMessage() {
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));
  reloadAIResponses();

  function startAvatarIntroduction() {
    document.getElementById("welcomeScreen").classList.add("hidden");
document.getElementById("avatarIntroScreen").classList.remove("hidden");

    console.log("üöÄ ÿØÿÆŸÑŸÜÿß ŸÅÿπŸÑÿßŸã ÿπŸÑŸâ startAvatarIntroduction()");

  const aiText = document.getElementById("introAiText");
  const aiDots = document.querySelector("#avatarIntroScreen .ai-dots");
  const avatarImg = document.getElementById("introAiAvatar");
  
  const savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  const lang = savedData.language || "ar";
  const gender = savedData.gender || "male";
  
  let message = "";

  if (lang === "ar") {
    if (gender === "male") {
      message = "ÿ£ŸáŸÑÿßŸã ÿ®ŸäŸÉ!\nÿ£ŸÜÿß ÿ®Ÿäÿ∂ÿ© ÿßŸÑÿ®ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ≤ÿ±ŸÇÿßÿ° ÿßŸÑŸÖÿ≤ÿ±ŸÇÿ¥ÿ©... ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä ÿπŸÑŸâ ŸÖÿ≤ÿßÿ¨Ÿä ŸÅÿßÿÆÿ± ŸÖŸÜ ÿßŸÑÿ¢ÿÆÿ±.\nŸÖŸáŸÖÿ™Ÿä ÿßŸÑÿ®ÿ≥Ÿäÿ∑ÿ©: ÿ£ÿÆŸÑŸäŸÉ ÿ™ÿ∑ŸÅÿ¥ Ÿàÿ™ŸÖÿ≥ÿ≠ ÿßŸÑŸÑÿπÿ®ÿ©!";
    } else {
      message = "ÿ£ŸáŸÑÿßŸã ÿ®ŸäŸÉŸä!\nÿ£ŸÜÿß ÿ®Ÿäÿ∂ÿ© ÿßŸÑÿ®ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ≤ÿ±ŸÇÿßÿ° ÿßŸÑŸÖÿ≤ÿ±ŸÇÿ¥ÿ©... ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä ÿπŸÑŸâ ŸÖÿ≤ÿßÿ¨Ÿä ŸÅÿßÿÆÿ± ŸÖŸÜ ÿßŸÑÿ¢ÿÆÿ±.\nŸÖŸáŸÖÿ™Ÿä ÿßŸÑŸÑÿ∞Ÿäÿ∞ÿ©: ÿ£ÿÆŸÑŸäŸÉŸä ÿ™ÿ≤ŸáŸÇŸä Ÿàÿ™ŸÖÿ≥ÿ≠Ÿä ÿßŸÑŸÑÿπÿ®ÿ©!";
    }
  } else if (lang === "en") {
    if (gender === "male") {
      message = "Hey there!\nI'm the Blue Penguin Egg... a sarcastic piece of AI made just to mess with you.\nMy simple mission: Make you rage quit and delete the game!";
    } else {
      message = "Hey girl!\nI'm the Blue Penguin Egg... a sarcastic piece of AI crafted just to drive you crazy.\nMy sweet mission: Make you rage quit and uninstall the game!";
    }
  }

  aiText.textContent = "";
  aiDots.style.display = "flex"; 

  setTimeout(() => {
    aiDots.style.display = "none"; 

    let charIndex = 0;
    function typeNextChar() {
      if (charIndex < message.length) {
        aiText.textContent += message[charIndex];
        charIndex++;
        setTimeout(typeNextChar, 40); // ÿ≥ÿ±ÿπÿ© ÿßŸÑŸÉÿ™ÿßÿ®ÿ©
      } else {
        
        setTimeout(() => {
  avatarImg.src = "assets/ai_angry.png";
  avatarImg.classList.add("shake");

  // üëá ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ±ÿßÿ± "ŸäŸÑÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©"
  const startBtn = document.createElement("button");
  startBtn.innerText = lang === "ar" ? "üéÆ ŸäŸÑÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©!" : "üéÆ Let's Start!";
  startBtn.className = "welcome-btn";
  startBtn.style.marginTop = "25px";
  startBtn.onclick = () => {
    document.getElementById("avatarIntroScreen").classList.add("hidden");
    switchScreen("menu");
  };

  document.getElementById("avatarWrapper").appendChild(startBtn);
}, 2000);

      }
    }

    typeNextChar();
  }, 1200);

}



  // ‚ùó ŸÜÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÑÿ∑ŸäŸÅÿ©
  document.getElementById("welcomeScreen").innerHTML = `
    <div class="welcome-card">
      <p id="loadingText">ü§ñ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ± ŸÑŸÖÿ∫ÿßŸÖÿ±ÿ™ŸÉ...</p>
      <div id="loadingAvatar" style="margin-top:20px;">
        <div class="bubble-inner">
          <img id="aiAvatarLoading" src="assets/ai_thinking.png" alt="AI" />
          <div class="ai-dots">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>
    </div>
  `;

  // ŸÜÿ®ÿØÿ£ ŸÅÿ≠ÿµ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
  const checkReady = setInterval(() => {
    if (window.aiReady) {
      clearInterval(checkReady);
      document.getElementById("welcomeScreen").style.display = "none";
document.getElementById("avatarIntroScreen").classList.remove("hidden");
startAvatarIntroduction();

    }
  }, 100);
}





    function showPlayerStats() {
      let savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
      let lang = savedData.language || 'ar';
      let t = applyLanguageText(lang);
      
      let highestScore = localStorage.getItem("blockHighestScore") || 0;
      let lastScore = localStorage.getItem("blockLastScore") || 0;
      let playCount = localStorage.getItem("blockPlayCount") || 0;

      let statsHTML = `
        ${t.genderLabel}: ${savedData.gender === 'male' ? (lang === 'ar' ? 'ŸàŸÑÿØ' : 'Boy') : (lang === 'ar' ? 'ÿ®ŸÜÿ™' : 'Girl')} 
        <button class="btn" style="padding:5px 10px; font-size:0.9rem;" onclick="changeGender()">${t.change}</button><br>

       

        ${t.langLabel}: ${lang === 'ar' ? 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'English'}
        <button class="btn" style="padding:5px 10px; font-size:0.9rem;" onclick="changeLanguage()">${t.change}</button><br>

        ${t.highScore}: ${highestScore}<br>
        ${t.lastScore}: ${lastScore}<br>
        ${t.playCount}: ${playCount}<br>
        ${gameTranslations[lang].levelMessage}
      `;

      document.getElementById("statsContent").innerHTML = statsHTML;
      document.getElementById("playerStats").style.display = "flex";
    }

    function changeGender() {
  let data = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  data.gender = (data.gender === 'male') ? 'female' : 'male';
  localStorage.setItem("blockPlayerData", JSON.stringify(data));
  reloadAIResponses(); // üëà ÿ™ÿ∂ŸäŸÅ ÿØŸä
  showPlayerStats();
}



function changeLanguage() {
  let data = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  data.language = (data.language === 'ar') ? 'en' : 'ar';
  localStorage.setItem("blockPlayerData", JSON.stringify(data));
  reloadAIResponses(); // üëà ÿ™ÿ∂ŸäŸÅ ÿØŸä
  showPlayerStats();
  applyLanguage();
}


    function closeStats() {
      document.getElementById("playerStats").style.display = "none";
    }

    function getAIPersonalMessage(score) {
      const lang = JSON.parse(localStorage.getItem("blockPlayerData"))?.language || 'ar';
      
      if(score < 100) return lang === 'ar' ? "ŸÑÿ≥Ÿá ÿ®ÿ™ÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©! üöÄ" : "Just starting! üöÄ";
      if(score < 500) return lang === 'ar' ? "ÿ£ÿØÿßÿ° ÿ¨ŸÖŸäŸÑ! üí™ ÿßÿ≥ÿ™ŸÖÿ±." : "Good performance! üí™ Keep going.";
      if(score < 1000) return lang === 'ar' ? "ÿ•ŸÜÿ™ ŸÖÿ≠ÿ™ÿ±ŸÅ! üî•" : "You're a pro! üî•";
      return gameTranslations[lang].levelMessage;
    }

    function applyLanguage() {
      const saved = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
      const lang = saved.language || "ar";
      const t = gameTranslations[lang];

      document.querySelector(".game-title").textContent = "Block Puzzle AI";
      document.querySelector(".start-btn").textContent = t.startBtn;
      document.querySelector(".stats-btn").textContent = t.statsBtn;
      document.getElementById("shareInsightBtn").textContent = lang === "ar"
  ? "üîó ÿ¥ÿßÿ±ŸÉ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸÖÿπ ÿµÿ≠ÿßÿ®ŸÉ"
  : "üîó Share Insight";

document.getElementById("closeInsightBtn").textContent = lang === "ar"
  ? "üèÅ ŸÉŸÅÿßŸäÿ© ÿ™ÿ≠ŸÑŸäŸÑ.. ŸÜÿ±ÿ¨ÿπÿü"
  : "üèÅ Enough insight.. go back?";

      document.getElementById("insightBtn").textContent = lang === "ar"
  ? "üìò ÿ™ŸÇÿ±Ÿäÿ± ÿ≠ÿßŸÑÿ™ŸÉ ÿßŸÑŸÜŸÅÿ≥Ÿäÿ©"
  : "üìò AI Insight Report";

      document.getElementById("scoreboard").textContent = t.scoreText + score;
      document.querySelector("#gameover h1").textContent = t.gameOver;
      document.getElementById("resumeBtn").textContent = t.resumeBtn;
      document.getElementById("restartBtn").textContent = t.restartBtn;
      document.getElementById("countdown").textContent = t.countdownText;
      document.getElementById("statsText").textContent = t.statsTitle;
      document.getElementById("backBtn").textContent = t.backBtn;

      if (document.getElementById("welcomeScreen").style.display !== "none") {
        chooseLanguage(lang);
      }
    }

    function shareInsight() {
  const report = document.getElementById("insightAiText").textContent;
  if (navigator.share) {
    navigator.share({
      title: "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®Ÿäÿ∂ÿ© üß†",
      text: report,
    }).then(() => {
      console.log("‚úÖ ÿ™ŸÖ ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ");
    }).catch(err => {
      alert("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©: " + err);
    });
  } else {
    alert("ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.");
  }
}


function closeInsight() {
  document.getElementById("insightScreen").classList.add("hidden");
  switchScreen("menu");
}




    function applyLanguageText(lang) {
      return {
        genderLabel: lang === 'ar' ? "üë§ ÿßŸÑŸÜŸàÿπ" : "üë§ Gender",
        ageLabel: lang === 'ar' ? "üéÇ ÿßŸÑÿ≥ŸÜ" : "üéÇ Age",
        langLabel: lang === 'ar' ? "üåç ÿßŸÑŸÑÿ∫ÿ©" : "üåç Language",
        highScore: lang === 'ar' ? "üèÜ ÿ£ÿπŸÑŸâ ŸÜÿ™Ÿäÿ¨ÿ©" : "üèÜ High Score",
        lastScore: lang === 'ar' ? "üéØ ÿ¢ÿÆÿ± ŸÜÿ™Ÿäÿ¨ÿ©" : "üéØ Last Score",
        playCount: lang === 'ar' ? "üî• ŸÖÿ±ÿßÿ™ ÿßŸÑŸÑÿπÿ®" : "üî• Play Count",
        aiMessage: lang === 'ar' ? "üí° ÿßŸÑŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉŸä" : "üí° Smart Assistant",
        change: lang === 'ar' ? "ÿ™ÿ∫ŸäŸäÿ±" : "Change"
      };
    }

    let idleTimer, idleRepeater;
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      clearInterval(idleRepeater);

      idleTimer = setTimeout(() => {
        showAIReaction("idle");
        idleRepeater = setInterval(() => {
          showAIReaction("idle");
        }, 15000);
      }, 12000);
    }

    ["pointerdown", "pointermove", "keydown"].forEach(evt =>
      window.addEventListener(evt, resetIdleTimer)
    );
    resetIdleTimer();

    function backToMenu() {
      clearInterval(monitorInterval);
      switchScreen("menu");
    }
    let countdownTimer;
let countdownSeconds = 5;

function startResumeCountdown() {
  countdownSeconds = 5;
  countdownEl.textContent = `Or wait ${countdownSeconds} seconds...`;
  countdownEl.classList.add("countdown-animate");
  
  // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≤ÿ± ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿπÿØ ÿßŸÑÿπŸÉÿ≥Ÿä
  document.getElementById("insightBtn").style.display = "none";
  
  countdownTimer = setInterval(() => {
    countdownSeconds--;
    countdownEl.textContent = `Or wait ${countdownSeconds} seconds...`;

    if (countdownSeconds <= 0) {
      clearInterval(countdownTimer);
      resumeBtn.style.display = "none";
      countdownEl.style.display = "none";
      
      finalScoreDisplay.textContent = `Score: ${score}`;
      finalScoreDisplay.classList.add("show", "bounce-in");
      restartBtn.style.display = "inline-block";
      
      // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≤ÿ± ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿπÿØ ŸÅŸÇÿ∑
      document.getElementById("insightBtn").style.display = "inline-block";
    }
  }, 1000);
}



    function getRandomAIResponse(eventType) {
  if (typeof aiResponses !== "undefined" && aiResponses[eventType] && aiResponses[eventType].length > 0) {
    const responses = aiResponses[eventType];
    const randomIndex = Math.floor(Math.random() * responses.length);
    console.log("ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ¨ŸÖŸÑÿ©:", responses[randomIndex]);
    return responses[randomIndex];
  }
  console.log("ŸÖŸÅŸäÿ¥ ÿ¨ŸÖŸÑ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿ≠ÿØÿ´:", eventType);
  return "";
}


function showReactionMessage(message) {
 const isGameActive = document.getElementById("game").classList.contains("active");
const isIntroActive = document.getElementById("avatarIntroScreen").classList.contains("active");
if (!(isGameActive || isIntroActive) || document.hidden) {

  isShowingMessage = false;
  return;
}


  SoundManager.play('bubbleAppear');
  const aiBubble = document.getElementById("aiBubble");
  const aiBoard = document.getElementById("aiBoard");
  const aiText = document.getElementById("aiText");
  const heatBar = document.getElementById("aiHeatBar");
  const aiDots = document.querySelector(".ai-dots");

  aiText.textContent = "";
  aiDots.style.display = "flex"; // ÿßÿ∏Ÿáÿßÿ± ÿßŸÑŸÜŸÇÿ∑ ÿßŸÑŸÑŸä ÿ®ÿ™ÿ™ÿ≠ÿ±ŸÉ

  aiBubble.classList.remove("hidden");
  aiBoard.classList.remove("hidden");
  aiBubble.classList.add("show");
  aiBoard.classList.add("show");
  aiText.classList.remove("hidden");
  aiText.classList.add("show");

  // Reset and animate the heat bar
  heatBar.style.width = "100%";
  heatBar.style.transition = "none";
  void heatBar.offsetWidth;
  heatBar.style.transition = "width 3s linear";
  heatBar.style.width = "0%";

  // ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ© ŸÖŸÜ ÿßŸÑÿ™ŸÅŸÉŸäÿ±ÿå Ÿäÿ®ÿØÿ£ ŸäŸÉÿ™ÿ® ÿßŸÑÿ¨ŸÖŸÑÿ©
  setTimeout(() => {
    aiDots.style.display = "none"; // ÿßÿÆŸÅÿßÿ° ÿßŸÑŸÜŸÇÿ∑
    let charIndex = 0;
    function typeNextChar() {
      if (charIndex < message.length) {
        aiText.textContent += message[charIndex];
        charIndex++;
        setTimeout(typeNextChar, 40); // ÿ≥ÿ±ÿπÿ© ÿßŸÑÿ≠ÿ±ŸÅ
      }
    }
    typeNextChar();
  }, 1000); // ŸàŸÇÿ™ ÿßŸÑÿ™ŸÅŸÉŸäÿ± ŸÇÿ®ŸÑ Ÿäÿ®ÿØÿ£ ŸäŸÉÿ™ÿ®

  // Hide after 3.5 seconds
  setTimeout(() => {
    aiBubble.classList.add("hide");
    aiBoard.classList.add("hide");
    aiText.classList.remove("show");

    setTimeout(() => {
      aiBubble.classList.remove("show", "hide");
      aiBoard.classList.remove("show", "hide");
      aiBubble.classList.add("hidden");
      aiBoard.classList.add("hidden");
      aiText.classList.add("hidden");

      processMessageQueue();
    }, 500);
  }, 3500);
}




function startAvatarBlink() {
  const avatarImg = document.getElementById("aiAvatar");
  setInterval(() => {
    avatarImg.classList.add("blink");
    setTimeout(() => {
      avatarImg.classList.remove("blink");
    }, 200); // ŸÖÿØÿ© ÿßŸÑÿ±ŸÖÿ¥
  }, 4000); // ŸÉŸÑ 4 ÿ´ŸàÿßŸÜŸä ÿ±ŸÖÿ¥ÿ©
}

startAvatarBlink();
window.allAIResponses = {}; // ŸÖŸÉÿßŸÜ ÿ™ÿÆÿ≤ŸäŸÜ ŸÉŸÑ ÿßŸÑÿ¨ŸÖŸÑ

function loadAllAIResponses(callback) {
 const configs = [
  'ar_male',
  'ar_female',
  'en_male',
  'en_female'
];


  let loadedCount = 0;
  const totalToLoad = configs.length;

  function checkAllLoaded() {
    loadedCount++;
    console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ (${loadedCount}/${totalToLoad})`);
    
    if (loadedCount === totalToLoad) {
      console.log("üéâ ÿßŸÉÿ™ŸÖŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ±ÿØŸàÿØ");
      if (callback) callback();
    }
  }

  configs.forEach(config => {
    const script = document.createElement('script');
    script.src = `ai_responses/aiResponses_${config}.js`;
    script.onload = function() {
      if (window.tempAIResponses) {
        window.allAIResponses[config] = window.tempAIResponses;
        delete window.tempAIResponses;
      }
      checkAllLoaded();
    };
    script.onerror = function() {
      console.error(`‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ: aiResponses_${config}.js`);
      window.allAIResponses[config] = {}; // ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ¶ŸÜ ŸÅÿßÿ±ÿ∫ ŸÉÿ®ÿØŸäŸÑ
      checkAllLoaded();
    };
    document.body.appendChild(script);
  });
}
function toggleSound() {
  isSoundOn = !isSoundOn;

  const icon = document.getElementById("soundIcon");

  if (isSoundOn) {
    icon.setAttribute("fill", "#2196F3");
    icon.setAttribute("d", "M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z");
  } else {
    icon.setAttribute("fill", "#ccc");
    icon.setAttribute("d", "M3 9v6h4l5 5V4L7 9H3z"); // ÿ¥ŸÉŸÑ ŸÖŸÉÿ®ÿ± ÿ®ÿØŸàŸÜ ŸÖŸàÿ¨ÿßÿ™
  }
}

window.onload = () => {
  loadAllAIResponses(() => {
    reloadAIResponses();
    let savedData = JSON.parse(localStorage.getItem("blockPlayerData"));
    if (savedData && savedData.language) {
      document.getElementById("welcomeScreen").style.display = "none";
      applyLanguage();
    }
    setupButtonSounds(); // <-- Ÿáÿ∞Ÿá ŸáŸä ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
  });
}

// Sound Manager - ŸäÿØŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿµŸàÿßÿ™ ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ©
const SoundManager = {
  sounds: {},
  
  loadSounds() {
    const files = {
      buttonClick: 'assets/sounds/button-click.mp3',
      shapePick: 'assets/sounds/shape-pick.mp3',
      singleClear: 'assets/sounds/singleClear.mp3',
      comboClear: 'assets/sounds/combo-clear.mp3',
      bubbleAppear: 'assets/sounds/bubble-appear.mp3',
     
    };

    for (let key in files) {
      const audio = new Audio(files[key]);
      audio.preload = 'auto';
      this.sounds[key] = audio;
    }

    console.log("üîä ÿßŸÑÿ£ÿµŸàÿßÿ™ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸáÿß");
  },

  play(name) {
    const s = this.sounds[name];
    if (s) {
      s.pause();      // ‚Üê ÿ∂ÿ±Ÿàÿ±Ÿä ŸÑŸà ÿ¥Ÿèÿ∫ŸÑ ŸÇÿ®ŸÑ ŸÉÿØŸá
      s.currentTime = 0;
      s.play().catch(err => {
        console.warn("üîá ÿÆÿ∑ÿ£ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™:", name, err);
      });
    }
  }
};

  </script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("grid");
  if (!grid) {
    console.warn("‚ö†Ô∏è ÿßŸÑÿπŸÜÿµÿ± #grid ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.");
    return;
  }

  window.manager = new Hammer.Manager(grid);

  const Pan = new Hammer.Pan({ threshold: 5 });
  manager.add(Pan);

  manager.on('panstart panmove panend', (e) => {
    const eventMap = {
      'panstart': 'pointerdown',
      'panmove': 'pointermove',
      'panend': 'pointerup'
    };

    const event = new PointerEvent(eventMap[e.type], {
      clientX: e.center.x,
      clientY: e.center.y
    });

    grid.dispatchEvent(event);
  });

  // üü¢ ÿ™ÿÆÿ≤ŸäŸÜŸá ŸÅŸä window ÿπŸÑÿ¥ÿßŸÜ ÿ™ÿ≥ÿ™ÿÆÿØŸÖŸá ŸÅŸä ÿ£ŸÖÿßŸÉŸÜ ÿ™ÿßŸÜŸäÿ© ŸÑŸà ÿ≠ÿ®Ÿäÿ™
  window.hammerManager = manager;
});
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("grid");
    if (!grid) {
      console.warn("‚ö†Ô∏è ÿßŸÑÿπŸÜÿµÿ± #grid ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ.");
      return;
    }
  
    window.manager = new Hammer.Manager(grid);
    const Pan = new Hammer.Pan({ threshold: 5 });
    window.manager.add(Pan);
  
    window.manager.on('panstart panmove panend', (e) => {
      const eventMap = {
        'panstart': 'pointerdown',
        'panmove': 'pointermove',
        'panend': 'pointerup'
      };
  
      const event = new PointerEvent(eventMap[e.type], {
        clientX: e.center.x,
        clientY: e.center.y
      });
  
      grid.dispatchEvent(event);
    });
  });
  </script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("grid");
    if (!grid) {
      console.warn("‚ö†Ô∏è ÿßŸÑÿπŸÜÿµÿ± #grid ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.");
      return;
    }
  
    window.manager = new Hammer.Manager(grid);
    const Pan = new Hammer.Pan({ threshold: 5 });
    window.manager.add(Pan);
  
    window.manager.on('panstart panmove panend', (e) => {
      const eventMap = {
        'panstart': 'pointerdown',
        'panmove': 'pointermove',
        'panend': 'pointerup'
      };
  
      const event = new PointerEvent(eventMap[e.type], {
        clientX: e.center.x,
        clientY: e.center.y
      });
  
      grid.dispatchEvent(event);
    });
  
    // ‚úÖ ÿ£Ÿä ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿßŸÜŸä ŸÑŸÑŸÄ manager ŸÑÿßÿ≤ŸÖ Ÿäÿ®ŸÇŸâ ŸáŸÜÿß ÿ£Ÿà ÿ®ÿπÿØŸá
  });
  </script>
  
</body>
</html>
